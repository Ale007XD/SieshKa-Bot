# Устранение неполадок

## Общие проблемы

### Бот не отвечает

**Проблема:** Бот не отвечает на команды

**Решение:**
1. Проверьте, что контейнер бота запущен:
   ```bash
   docker-compose ps
   ```
2. Проверьте логи:
   ```bash
   docker-compose logs bot
   ```
3. Убедитесь, что BOT_TOKEN корректен
4. Перезапустите бота:
   ```bash
   docker-compose restart bot
   ```

### Ошибка подключения к базе данных

**Проблема:** `could not connect to server: Connection refused`

**Решение:**
1. Проверьте, что PostgreSQL запущен:
   ```bash
   docker-compose ps postgres
   ```
2. Проверьте переменные окружения в .env
3. Дождитесь полной инициализации PostgreSQL (может занять 10-30 секунд)
4. Перезапустите сервисы:
   ```bash
   docker-compose down
   docker-compose up -d
   ```

### Миграции не применяются

**Проблема:** `relation does not exist`

**Решение:**
```bash
# Применить миграции вручную
docker-compose run --rm api alembic upgrade head

# Или с нуля
docker-compose run --rm api alembic downgrade base
docker-compose run --rm api alembic upgrade head
```

## Проблемы с заказами

### Заказ не создается

**Проверьте:**
1. Пользователь добавил товары в корзину
2. Указан корректный адрес и телефон
3. Выбран способ оплаты
4. В БД есть соответствующие товары

### Заказ завис в статусе

**Решение:**
1. Откройте заказ через админ-панель
2. Вручную измените статус
3. Проверьте логи на ошибки

## Проблемы с меню

### Товары не отображаются

**Проверьте:**
1. Товар активен (is_active=true)
2. Товар не в архиве (is_archived=false)
3. Категория активна
4. У товара указана цена > 0

### Не могу добавить товар в корзину

**Причины:**
1. Товар неактивен
2. Товар в архиве
3. Товара нет в наличии (stock_quantity=0)
4. Проблемы с Redis

## Проблемы с Redis

### Ошибка подключения к Redis

**Решение:**
```bash
# Перезапуск Redis
docker-compose restart redis

# Проверка
docker-compose exec redis redis-cli ping
```

## Проблемы с Celery

### Задачи не выполняются

**Проверьте:**
```bash
# Статус worker'ов
docker-compose ps celery_worker celery_beat

# Логи
docker-compose logs celery_worker
```

**Решение:**
1. Перезапустите Celery:
   ```bash
   docker-compose restart celery_worker celery_beat
   ```
2. Проверьте Redis
3. Проверьте логи на ошибки

## Проблемы с бэкапами

### Бэкап не создается

**Проверьте:**
1. Права на директорию `./backups`
2. Подключение к PostgreSQL
3. Достаточно места на диске

**Решение:**
```bash
# Создать директорию с правами
mkdir -p backups
chmod 755 backups

# Запустить бэкап вручную
./scripts/backup/run_backup.sh
```

### Бэкап не отправляется в Telegram

**Причины:**
1. Файл больше 50MB
2. Неверный BACKUP_TG_CHAT_ID
3. Бот не добавлен в группу

**Решение:**
1. Проверьте настройки в .env
2. Убедитесь, что бот является админом в группе
3. Уменьшите BACKUP_MAX_TG_MB

## Проблемы производительности

### Медленная работа бота

**Причины и решения:**
1. **Большое меню** - добавьте пагинацию
2. **Много заказов** - используйте фильтры
3. **Медленная БД** - добавьте индексы
4. **Нехватка памяти** - увеличьте RAM сервера

### Высокая нагрузка на CPU

**Решение:**
1. Увеличьте количество worker'ов API
2. Включите кэширование
3. Оптимизируйте запросы

## Ошибки Docker

### Контейнеры не запускаются

```bash
# Проверка конфигурации
docker-compose config

# Пересборка
docker-compose down
docker-compose up --build -d
```

### Нехватка места на диске

```bash
# Очистка
docker system prune -a
docker volume prune

# Проверка размера
docker system df
```

## Получение помощи

Если проблема не решена:

1. Соберите информацию:
   - Логи ошибок
   - Версии компонентов
   - Конфигурацию (.env без секретов)

2. Создайте Issue с описанием:
   - Что происходит
   - Что ожидалось
   - Шаги воспроизведения
   - Логи ошибок

## Полезные команды

```bash
# Просмотр всех логов
docker-compose logs -f

# Просмотр логов конкретного сервиса
docker-compose logs -f api

# Вход в контейнер
docker-compose exec api bash

# Проверка состояния
docker-compose ps

# Перезапуск
docker-compose restart

# Полный сброс
docker-compose down -v
docker-compose up -d
```
